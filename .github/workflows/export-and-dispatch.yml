name: Export Add-on & Notify Aggregator

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare export branch from subdirectory
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git subtree split --prefix=komodo-periphery -b export
          git push --force origin export

      - name: Notify aggregator via repository_dispatch
        if: success()
        env:
          AGGREGATOR_REPO: ${{ secrets.AGGREGATOR_REPO }}
          AGGREGATOR_TOKEN: ${{ secrets.AGGREGATOR_TOKEN }}
        run: |
          if [[ -z "$AGGREGATOR_REPO" || -z "$AGGREGATOR_TOKEN" ]]; then
            echo "AGGREGATOR_REPO and AGGREGATOR_TOKEN must be set as repo secrets" >&2
            exit 1
          fi
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${AGGREGATOR_TOKEN}" \
            https://api.github.com/repos/${AGGREGATOR_REPO}/dispatches \
            -d @- <<'JSON'
          {
            "event_type": "addon_release",
            "client_payload": {
              "name": "komodo-periphery",
              "repo": "https://github.com/${{ github.repository }}.git",
              "ref": "export"
            }
          }
JSON

